# nginx/nginx.conf

# Define o contexto de eventos (necessário para a sintaxe do Nginx, pode ser deixado em branco)
events {}

# Define o contexto HTTP, onde a magia acontece
http {
    # Define um servidor virtual que irá lidar com as requisições
    server {
        # O Nginx escutará na porta 80 (a porta padrão para tráfego HTTP) dentro do container
        listen 80;

        # Define a regra APENAS para os pedidos que começam com /estoque/
        location /estoque/ {
            # Esta linha é crucial. Ela remove o prefixo /estoque do URL
            # antes de o encaminhar para a aplicação FastAPI.
            # Sem isto, o FastAPI receberia um pedido para /estoque/login
            # em vez de /login, e não encontraria a rota.
            rewrite ^/estoque/(.*)$ /$1 break;

            # Esta linha interceta os redirecionamentos da aplicação (ex: para /login)
            # e corrige-os para incluir o prefixo (ex: para /estoque/login).
            proxy_redirect / /estoque/;

            # Cabeçalhos importantes para passar informações da requisição original para a aplicação.
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # A linha mais importante:
            # Encaminha (proxy_pass) a requisição para o nosso serviço 'app',
            # que está a correr na porta 8000 dentro da rede interna do Docker.
            proxy_pass http://app:8000;
        }
    }
}

